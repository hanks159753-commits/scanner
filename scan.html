<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR Scanner</title>

<link rel="stylesheet" href="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.css">

<style>
  body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
  #reader { width: 320px; height: 180px; border: 1px solid #ccc; border-radius: 8px; margin-top: 8px; }
  #log { margin-top: 12px; color: #444; white-space: pre-wrap; }
  button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #f7f7f7; }
</style>

<h3>QR 即時掃描（GitHub Pages）</h3>
<button id="btnStart">啟動相機掃描</button>
<div id="reader"></div>
<div id="result"><strong>結果：</strong><span id="txt"></span></div>
<div id="log"></div>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
  const readerId = "reader";
  const log = (m) => document.getElementById('log').textContent = String(m ?? '');
  const show = (t) => document.getElementById('txt').textContent = t;

  let html5QrCode = null;
  let running = false;

  async function startScan() {
    try {
      if (running) return;
      log("請允許使用相機…");
      html5QrCode = new Html5Qrcode(readerId, /* verbose= */ false);

      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 300, height: 100 } },   // 你要的 300×100 掃描框
        (decodedText) => {
          show(decodedText);
          // 如需回傳父頁（你的 HTTP 網站），解除以下註解並把 ORIGIN 改成你的主站
          // window.parent.postMessage({ type: "QR_DECODED", data: decodedText }, "http://YOUR_HTTP_SITE");
        },
        (scanErr) => { /* 掃描過程中的嘗試錯誤，通常可忽略 */ }
      );
      running = true;
      log("掃描中…把 QR 放進框內");
    } catch (e) {
      log("開相機失敗：\n" + e);
    }
  }

  document.getElementById('btnStart').addEventListener('click', startScan);

  // 安全起見：離開頁面或隱藏時停止鏡頭
  window.addEventListener('pagehide', async () => {
    try { if (html5QrCode && running) { await html5QrCode.stop(); running = false; } } catch {}
  });
</script>
